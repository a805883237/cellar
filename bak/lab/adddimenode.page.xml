<?xml version="1.0" encoding="UTF-8"?>
<page xmlns="http://ipage.baidu.com">

	<service ref="queryProdlineListForSelect" alias="queryAllProdlineList">
        <param key="allFlag" value="${acsUrl.allFlag}" />
        <param key="jsonValue" value="${acsUrl.jsonValue}" />
		<param key="adminProdIdStr" value="${acsUrl.adminProdIdStr}" />
    </service>
    
    <service ref="dacDimeListComoboByJava" alias="dacDimeListComoboByJava"/>
    
    <event source="addNodeProdLine">
 		<command type="reloadByAjax">
            <property key="target" value="dimension-ownOrg" />
            <property key="disableIfNull" value="true" />
            <property key="clear" value="dimension-ownOrg" />
            <service ref="queryOrgByJava">
                <param key="parentOrgId" value="-1"/>
                <param key="prodId" type="context" value="value" />
            </service>
        </command>
        <command type="reloadByAjax">
            <property key="target" value="addNodeDimeId" />
            <property key="clear" value="addNodeDimeId" />
            <service ref="dacDimeListComoboByJava">
                <param key="prodId" type="context" value="value" />
            </service>
        </command>
        
    </event>
     
    <event source="addNodeDimeId">
        <command type="reloadByAjax">
                 <property key="target" value="dimension-dimtype" />
                 <property key="disableIfNull" value="true" />
                 <property key="clear" value="dimension-dimtype" />
                 <service ref="dacDimeNodeTypeComoboByJava">
                         <param key="dimeId" type="context" value="value" />
                 </service>
        </command>
        <command type="reloadByAjax">
                 <property key="target" value="dimension-parentdim" />
                 <property key="disableIfNull" value="true" />
                 <property key="clear" value="dimension-parentdim" />
                 <service ref="queryDacNodeByJava">
                         <param key="dacDimeId" type="context" value="value" />
                 </service>
        </command>
    </event>
     
    <body uid="body" id="body" type="body">
    	
        <div id="panel1">
            <div id="addDimeNodeForm" class="grid">
                <property value="120px" key="labelWidth">
                </property>
                <property value="1" key="gridCount">
                </property>
                <item id="requestParentNodeIdParam" type="value" show="false" value="${request.parentNodeId}" />
                <item id="addNodeProdLine" name="prodId" width="250px" value="${request.prodId}"  label="所属产品线" type="select" required="true">
                    <json>
                        ${service.queryAllProdlineList.data.toJson()}
                    </json>
                </item>
                <item id="dimension-ownOrg" name="orgId" width="250px"  label="所属组织机构"  type="input-tree">
                	<property key="asyn" value="true" />
                    <property key="nullable" value="true" />
                    <property key="nullValue" value="-1" />
                    <property key="idKey" value="parentOrgId" />
                </item>
                <item id="addNodeDimeId" name="dacDimeId" width="250px" label="所属维度" type="select">
                </item>
                <item id="dimension-parentdim" name="parentNodeId" width="250px"  label="父节点" type="input-tree">
                    <property key="asyn" value="true" />
                    <property key="nullable" value="true" />
                    <property key="idKey" value="parentNodeId" />
                    <service ref="queryDacNodeByJava">
                            <param key="dacDimeId" type="UIValue" value="addNodeDimeId" />
                    </service>
                </item>
                <item id="dimension-dimEnname" name="enName" width="250px" value="" label="节点英文名" type="input" required="true" readonly="false">
                </item>
                <item id="dimension-dimCnname" name="cnName" width="250px" value="" label="节点中文名" type="input" required="true">
                </item>
                
                <item id="dimension-dimtype" name="nodeTypeId" width="250px"  label="节点类型" type="select" required="true">
                </item>
                <item id="dimension-dimdesc" name="descn" width="250px" value="" label="描述" type="textarea">
                </item>
            </div>
            <div id="grid-1427799424028" name="" class="grid">
                <property value="1" key="gridCount">
                </property>
                <action id="action-1427799471110" name="增加">
                	<property key="notAlert" value="true"/>
                	<command type="execute">
                		<service ref="addDacDimeNodeByJava">
                			<param key=""  type="form" value="addDimeNodeForm"/>
                		</service>
                	</command>
                	 <command type="alert">
                      <property key="msg" value="岗位新增成功"/>
                    </command>
                  	<command type="closeDialog"/>
                  	<command type="tableQuery">
				       <property key="formId" value="dimNodeQuery"/>
				       <property key="tableId" value="queryDimeNodeInfo"/>
				       <property key="isPrev" value="true" />
                        <property key="pageNum" value="currentPage" />
				    </command>
                </action>
                <action id="action-1427799473786" name="取消">
                	<command type="closeDialog" />
                </action>
            </div>
        </div>
        
    </body>
    <command>

        function doCommand(page, props, context, next) {
            var parentNodeId = page.getValue('requestParentNodeIdParam');
            if (parentNodeId !== undefined || parentNodeId !== '') {
                var tempParamAry = parentNodeId.split('-');
                nodeType = tempParamAry[0];
                if (nodeType === 'DIME') {
                    dacDimeId = tempParamAry[1];
                    debugger;
                    page.setValue('addNodeDimeId', dacDimeId);
                    next(function () {
                        delaySetValue();
                    });
    
                    // 为了等待 option 加载和渲染完成延时设值
                    function delaySetValue() {
                        setTimeout(function () {
                            page.setValue('addNodeDimeId', dacDimeId);
                            if (page.getItem('addNodeDimeId').getValue() !== dacDimeId) {
                                delaySetValue();
                            }
    
                        }, 1500);
                    }
                }
                else if (nodeType === 'NODE') {
                    dimeNodeId = tempParamAry[1];
                    iPage.ajax('queryDacDimeNodeById.do', {
                        dacDimeNodeId: dimeNodeId
                    }, function (data) {
                        var result = JSON.parse(data);
                        debugger;
                        next(function () {
                            delaySetValue();
                        });
    
                        // 为了等待 option 加载和渲染完成延时设值
                        function delaySetValue() {
                            setTimeout(function () {
                                page.setValue('addNodeDimeId', result.data.dacDimeId);
                                page.setValue('dimension-parentdim', dimeNodeId);
    
                                if (page.getItem('addNodeDimeId').getValue() !== result.data.dacDimeId
                                    || page.getItem('dimension-parentdim').getValue() !== dimeNodeId
                                ) {
                                    delaySetValue();
                                }
    
                            }, 1500);
                        }
    
                    }, function (msg) {
                        iPage.error(msg);
                    }); // ajax end
                }
            }
            else {
                // last nest
                next();
            }
        }        
        
    </command>
</page>