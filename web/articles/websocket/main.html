<!DOCTYPE html>
<html>
<head lang="zh-cn">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>WebSocket - 龙则的博客站点</title>
    <link href="/src/css/all.css" rel="stylesheet"/>
</head>
<body>
<header class="page-header">
    <h1>
        <span class="main-title">龙则的个人站点</span>
        <span class="subtitle">记录我在北京的生活与感悟，记录在某大公司的技术(主要是前端)研究</span>
    </h1>
    <nav class="nav">
        <button class="icon-menu-button"></button>
        <menu>
            <a class="item">Home</a>
            <a class="item">前端技术</a>
            <a class="item">技术梳理</a>
            <a class="item">本站成书</a>
            <a class="item">本站 & 站主</a>
        </menu>
    </nav>
</header>
<div class="page-body">
    <div class="article-detail-container">
    <h1 id="websocket">WebSocket</h1>
<h2 id="-">概述</h2>
<p>一个双向链接协议，本文主要介绍Node下的实例。更理论的东西请移步这篇知乎帖子：
<a href="http://www.zhihu.com/question/20215561">http://www.zhihu.com/question/20215561</a></p>
<h2 id="-">安装</h2>
<p>全局安装 </p>
<pre><code>npm install -g websocket
</code></pre><p>局部安装 </p>
<p>   npm install websocket</p>
<p>需要注意的是安装目录需要有package.json文件，否则安装失败。</p>
<h2 id="-">描述</h2>
<p>做技术探索，从前端到后端搭建 websocket 的应用。建立双相连接，前端和后端互发信息。</p>
<p>页面表现为通过不同的浏览器 或者 多台设备访问同一页面，在其中的一台设备上的操作一个div块的背景颜色会同步到其他浏览器或设备上。</p>
<h2 id="-">后端</h2>
<pre><code>var SocketServer = require(&#39;websocket&#39;).server;

// 防止socket重复开启
if (global.siteSocketServer !== undefined) {
    return {
        status: 1,
        data: &#39;socket接口已经开启&#39;
    };
}

// 开启socket服务
var socket = new SocketServer({
    httpServer: global.siteHttpServer
});
global.siteSocketServer = socket;

var redBlackBox = [];
// 服务监听
socket.on(&#39;request&#39;, function (request) {

    var connection = request.accept(null, request.origin);

    connection.on(&#39;close&#39;, function () {
        // 从队列中移除已关闭的链接
        for(var i = 0, len = redBlackBox.length; i &lt; len; i++) {
            if (redBlackBox[i] === this) {
                redBlackBox.splice(i, 1);
                break;
            }
        }
    });

    // 超级简化的路由
    if (request.resource === &#39;/red-black-box&#39;) {
        connection.on(&#39;message&#39;, function (message) {
            // 将消息分发
            for(var i = 0, len = redBlackBox.length; i &lt; len; i++) {
                redBlackBox[i].send(message.utf8Data);
            }
        });
        redBlackBox.push(connection);
    }
});

return {
    status: 0,
    data: &#39;socket接口初始化完成&#39;
};
</code></pre><p>data函数是一个普通的http服务所调用的函数，可以在<a href="https://github.com/longze/cellar">GitHub</a> 上 service/websocket-demo 下找到并运行。在服务器端用 <code>connection.send</code> 向客户端发信息，用 <code>connection.on(&#39;message&#39;, callback）</code> 监听客户端发来的信息，连接建立后每隔3秒会向客户端发送消息。</p>
<h2 id="-">前端脚本</h2>
<pre><code>var host = &#39;ws://&#39; + location.host + &#39;/red-black-box&#39;;
// 和服务器建立socket连接，信道建立
socket = new WebSocket(host);

socket.onopen = function () {

};

// 接受来自服务器的消息
socket.onmessage = function (message) {
    $(&#39;.con&#39;).css({
        background: message.data
    });
};

socket.onerror = function (error) {
    console.log(&#39;WebSocket 链接错误: &#39; + error);
};

$(&#39;div div&#39;).click(function () {
    // 发送消息
    socket.send($(this).attr(&#39;id&#39;));
});
</code></pre><p>为了简单起见，我们用jQuery的Ajax发起开启websocket的请求，我们用 <code>socket.send</code> 向服务器发送请求，用 <code>socket.onmessage</code> 监听服务器发来的信息。</p>
<h2 id="-">浏览器支持情况</h2>
<p>Chrome 14 </p>
<p>Firefox 7 </p>
<p>IE 9 - via downloadable Silverlight extension</p>
<p>IE 10 (from Windows 8 developer preview) </p>
<p>Safari 5.0.2 </p>
<p>iOS 4.2</p>
<p>信息来源：<a href="http://stackoverflow.com/questions/1253683/what-browsers-support-html5-websocket-api">http://stackoverflow.com/questions/1253683/what-browsers-support-html5-websocket-api</a></p>

    </div>
    <div class="article-message-container"></div>
</div>
<footer class="page-footer"></footer>
</body>
</html>